on: [ push, pull_request ]

name: CI (macos/linux)

jobs:
  build_test_fmt_clippy:
    name: Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # macOS: Intel processor; oldest version GitHub provides as of 2025-07-28
        # Ubuntu: LTS version based on Debian Bookworm
        os: [macos-13, ubuntu-22.04]
        rust:
          - stable
        llvm_version: [12, 13]
      fail-fast: false
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2

    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ matrix.rust }}
        override: true
        components: rustfmt, clippy

    - name: Cache Rust environment
      uses: Swatinem/rust-cache@v1

    - name: Install LLVM
      uses: KyleMayes/install-llvm-action@v1
      with:
        version: "${{ matrix.llvm_version }}.0"

    - name: Install missing LLVM deps
      if: contains(matrix.os, 'ubuntu')
      run: sudo apt-get install -y libtinfo5

    - name: Show llvm-config output for debugging purposes
      run: |
        for flag in build-mode cflags libdir libnames system-libs version; do
          echo "\$ llvm-config --$flag"
          llvm-config --$flag
        done

    - name: Install cargo-make
      uses: actions-rs/cargo@v1
      with:
        command: install
        args: --debug cargo-make

    - name: Run cargo build, test, fmt, clippy
      env:
        LLVM_FEATURE: llvm${{ matrix.llvm_version }}-0
      run: cargo make ci-flow
